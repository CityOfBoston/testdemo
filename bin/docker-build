#!/bin/bash

PWD=$(pwd)
DOCKERHOST=$(ifconfig | grep -E "([0-9]{1,3}\.){3}[0-9]{1,3}" | grep -v 127.0.0.1 | awk '{ print $2 }' | cut -f2 -d: | head -n1)
RELEASE=$(git rev-parse --verify HEAD)
APP=$(basename $PWD)
INSTANCE=$(git rev-parse --abbrev-ref HEAD)
BRANCH=$(git rev-parse --abbrev-ref HEAD)

usage() {
    cat <<EOF
Usage: $0 [-a|--app-name <name>] [-i|--instance-name <name>]

    Build the Docker container.

    -a | --app-name <name>
        The name of the app. Defaults to the name of the project directory

    -i | --instance-name <name>
        The name of the test instance. Defaults to the branch name

    -h | --help
        This help message
EOF
    exit 1;
}

while (( "$#" )); do
  [[ $1 == --*=* ]] && set -- "${1%%=*}" "${1#*=}" "${@:2}"
  case "$1" in
    -a|--app-name)
      APP=$2
      shift 2
      ;;
    -i|--instance-name)
      INSTANCE=$2
      shift 2
      ;;
    -h|--help)
      usage
      ;;
    --) # end argument parsing
      shift
      break
      ;;
    -*|--*=) # unsupported flags
      echo "Error: Unsupported flag $1" >&2
      usage
      ;;
  esac
done

echo "Building container with variables:"
echo "  APP_NAME: $APP"
echo "  INSTANCE_NAME: $INSTANCE"
echo "  BRANCH_NAME: $BRANCH"
echo "  RELEASE: $RELEASE"

gatsby build

docker build \
    -t $APP/$INSTANCE \
    --build-arg RELEASE=$RELEASE \
    --build-arg APP_NAME=$APP \
    --build-arg BRANCH_NAME=$BRANCH \
    --build-arg INSTANCE_NAME=$INSTANCE \
    .
